generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          Int                      @id @default(autoincrement())
  name        String                   @unique
  logos       OrganizationLogo[]
  memberships OrganizationMembership[]

  @@map("organizations")
}

model OrganizationLogo {
  id             Int          @id @default(autoincrement())
  organizationId Int          @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  fileId         Int          @unique @map("file_id")
  file           File         @relation(fields: [fileId], references: [id])

  @@map("organization_logos")
}

enum ContentType {
  JPEG
  PNG
  WEBP
  AVIF
  GIF
  PDF
}

enum ServiceType {
  S3
  GCS
  R2
}

model File {
  id          Int         @id @default(autoincrement())
  publicId    String      @unique @map("public_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  serviceType ServiceType @map("service_type")
  fileKey     String      @map("file_key")
  fileName    String      @map("file_name")
  byteSize    Int         @map("byte_size")
  contentUrl  String      @map("content_url")
  contentType ContentType @map("content_type")
  width       Int?
  height      Int?
  signedUrl   String?     @map("signed_url") @db.VarChar(2048)
  expiresAt   DateTime?   @map("expires_at")

  organizationLogo OrganizationLogo?

  @@map("files")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String                   @unique
  userRoles               UserRole[]
  userPermissions         UserPermission[]
  organizationMemberships OrganizationMembership[]

  @@map("users")
}

model OrganizationMembership {
  id             Int          @id @default(autoincrement())
  organizationId Int          @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  userId         Int          @map("user_id")
  user           User         @relation(fields: [userId], references: [id])

  @@map("organization_memberships")
}

model Role {
  id           Int        @id @default(autoincrement())
  roleName     String     @unique @map("role_name") @db.VarChar(255)
  parentRoleId Int?       @map("parent_role_id") @db.SmallInt
  parentRole   Role?      @relation("hierarchical_roles", fields: [parentRoleId], references: [id])
  childRoles   Role[]     @relation("hierarchical_roles")
  users        UserRole[]

  @@map("roles")
}

model UserRole {
  userId Int  @map("user_id")
  user   User @relation(fields: [userId], references: [id])
  roleId Int  @map("role_id")
  role   Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model Permission {
  id              Int    @id @default(autoincrement()) @db.SmallInt
  permissionLabel String @unique @map("permission_label") @db.VarChar(255)

  @@map("permissions")
}

model UserPermission {
  userId Int  @id @map("user_id")
  user   User @relation(fields: [userId], references: [id])

  @@map("user_permissions")
}
