generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  archivedAt    DateTime? @map("archived_at")
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?

  accounts    Account[]
  sessions    Session[]
  avatar      UserAvatar?
  memberships ImplementerMember[]
  recentOpens UserRecentOpen[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Implementer {
  id                 String              @id @db.VarChar(255)
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  archivedAt         DateTime?           @map("archived_at")
  visibleId          String              @unique @map("visible_id") @db.VarChar(10) // e.g. Imp_1
  implementerName    String              @map("implementer_name")
  implementerType    String              @map("implementer_type") // e.g. NGO
  implementerAddress String?             @map("implementer_address") // e.g. MAWEHSI GARDENS, OFF Matumbato Rd, Nairobi
  countyOfOperation  String?             @map("county_of_operation") // e.g. Makueni
  pointPersonName    String?             @map("point_person_name") // e.g. Beverly
  pointPersonPhone   String?             @map("point_person_phone") // e.g. 0712345678
  pointPersonEmail   String?             @map("point_person_email") // e.g. timothy@amhrtf.org
  avatar             ImplementerAvatar?
  memberships        ImplementerMember[]
  invites            ImplementerInvite[]
  fellows            Fellow[]
  hubs               Hub[]
  hubCoordinators    HubCoordinator[]
  // projects           Project[]
  schools            School[]
  supervisors        Supervisor[]
  Student            Student[]

  @@map("implementers")
}

model ImplementerAvatar {
  id            String      @id @db.VarChar(255)
  implementerId String      @unique @map("implementer_id")
  implementer   Implementer @relation(fields: [implementerId], references: [id])
  fileId        String      @unique @map("file_id")
  file          File        @relation(fields: [fileId], references: [id])

  @@map("implementer_avatars")
}

model File {
  id                String             @id @db.VarChar(255)
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  archivedAt        DateTime?          @map("archived_at")
  key               String             @map("key")
  fileName          String             @map("file_name")
  byteSize          Int                @map("byte_size")
  contentType       String             @map("content_type")
  width             Int?
  height            Int?
  signedUrl         String?            @map("signed_url") @db.VarChar(2048)
  expiresAt         DateTime?          @map("expires_at")
  implementerAvatar ImplementerAvatar?
  userAvatar        UserAvatar?

  @@map("files")
}

model UserRecentOpen {
  id       Int      @id @default(autoincrement())
  userId   String   @map("user_id") @db.VarChar(255)
  user     User     @relation(fields: [userId], references: [id])
  itemId   String   @map("item_id") // TODO: itemId leverages object ids (e.g. school_01hbnsp5eserr939h1v6s1ty5r) and polymorphic associations
  openedAt DateTime @default(now()) @map("opened_at")

  @@index([userId, itemId])
  @@map("user_recent_opens")
}

model UserAvatar {
  id     String @id @db.VarChar(255)
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])
  fileId String @unique @map("file_id")
  file   File   @relation(fields: [fileId], references: [id])

  @@map("user_avatars")
}

model ImplementerMember {
  id            Int                @id @default(autoincrement())
  implementerId String             @map("implementer_id") @db.VarChar(255)
  implementer   Implementer        @relation(fields: [implementerId], references: [id])
  userId        String             @map("user_id") @db.VarChar(255)
  user          User               @relation(fields: [userId], references: [id])
  roles         MemberRole[]
  permissions   MemberPermission[]
  supervisors   Supervisor[]

  @@map("implementer_members")
}

model ImplementerInvite {
  id            Int         @id @default(autoincrement())
  email         String
  implementerId String      @map("implementer_id") @db.VarChar(255)
  implementer   Implementer @relation(fields: [implementerId], references: [id])
  sentAt        DateTime    @default(now()) @map("sent_at")
  expiresAt     DateTime    @map("expires_at")
  acceptedAt    DateTime?   @map("accepted_at")
  roleId        String      @map("role_id") @db.VarChar(255)
  role          Role        @relation(fields: [roleId], references: [id])
  secureToken   String      @map("secure_token")

  @@unique([email, implementerId, secureToken])
  @@map("implementer_invites")
}

model Role {
  id          String              @id @db.VarChar(255)
  name        String              @db.VarChar(255)
  description String              @db.VarChar(255)
  members     MemberRole[]
  permissions RolePermission[]
  invites     ImplementerInvite[]

  @@map("roles")
}

model MemberRole {
  id       Int               @id @default(autoincrement())
  memberId Int               @map("member_id")
  member   ImplementerMember @relation(fields: [memberId], references: [id])
  roleId   String            @map("role_id") @db.VarChar(255)
  role     Role              @relation(fields: [roleId], references: [id])

  @@map("member_roles")
}

model Permission {
  id                Int                @id @default(autoincrement()) @db.SmallInt
  permissionLabel   String             @unique @map("permission_label") @db.VarChar(255)
  memberPermissions MemberPermission[]
  rolePermissions   RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       String     @map("role_id") @db.VarChar(255)
  role         Role       @relation(fields: [roleId], references: [id])
  permissionId Int        @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@map("role_permissions")
}

model MemberPermission {
  id           Int               @id @default(autoincrement())
  memberId     Int               @map("member_id")
  member       ImplementerMember @relation(fields: [memberId], references: [id])
  permissionId Int               @map("permission_id")
  permission   Permission        @relation(fields: [permissionId], references: [id])

  @@map("member_permissions")
}

model Student {
  id                   String       @id @db.VarChar(255)
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  archivedAt           DateTime?    @map("archived_at")
  studentName          String?      @map("student_name") @db.VarChar(255)
  visibleId            String       @unique @map("visible_id") @db.VarChar(100)
  fellowId             String?      @map("fellow_id") @db.VarChar(255)
  fellow               Fellow?      @relation(fields: [fellowId], references: [id])
  supervisorId         String?      @map("supervisor_id") @db.VarChar(255)
  supervisor           Supervisor?  @relation(fields: [supervisorId], references: [id])
  implementerId        String?      @map("implementer_id") @db.VarChar(255)
  implementer          Implementer? @relation(fields: [implementerId], references: [id])
  schoolId             String?      @map("school_id") @db.VarChar(255)
  school               School?      @relation(fields: [schoolId], references: [id])
  yearOfImplementation Int?         @map("year_of_implementation")
  admissionNumber      String?      @map("admission_number") @db.VarChar(255)
  age                  Int?
  gender               String?      @db.VarChar(10)
  form                 Int?
  stream               String?      @db.VarChar(255)
  condition            String?      @db.VarChar(255)
  intervention         String?      @db.VarChar(255)
  tribe                String?      @db.VarChar(255)
  county               String?      @db.VarChar(255)
  financialStatus      String?      @map("financial_status") @db.VarChar(255)
  home                 String?      @db.VarChar(255)
  siblings             String?      @db.VarChar(255)
  religion             String?      @db.VarChar(255)
  group                String?      @db.VarChar(255)
  survivingParents     String?      @map("surviving_parents") @db.VarChar(255)
  parentsDead          String?      @map("parents_dead") @db.VarChar(255)
  fathersEducation     String?      @map("fathers_education") @db.VarChar(255)
  mothersEducation     String?      @map("mothers_education") @db.VarChar(255)
  coCurricular         String?      @map("co_curricular") @db.VarChar(255)
  sports               String?      @db.VarChar(255)
  createScreeningId    Boolean?     @map("create_screening_id")
  phoneNumber          String?      @map("phone_number") @db.VarChar(255)
  mpesaNumber          String?      @map("mpesa_number") @db.VarChar(255)
  attendanceSession0   Boolean?     @map("attendance_session_0")
  attendanceSession1   Boolean?     @map("attendance_session_1")
  attendanceSession2   Boolean?     @map("attendance_session_2")
  attendanceSession3   Boolean?     @map("attendance_session_3")
  attendanceSession4   Boolean?     @map("attendance_session_4")

  @@map("students")
}

/// Fellows are the lay-providers, group leaders of the Shamiri Intervention.
model Fellow {
  id                   String       @id @db.VarChar(255)
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")
  archivedAt           DateTime?    @map("archived_at")
  visibleId            String       @unique @map("visible_id") @db.VarChar(100)
  fellowName           String?      @map("fellow_name") @db.VarChar(255)
  fellowEmail          String?      @map("fellow_email") @db.VarChar(255)
  yearOfImplementation Int?         @map("year_of_implementation")
  mpesaName            String?      @map("mpesa_name") @db.VarChar(255)
  mpesaNumber          String?      @map("mpesa_number") @db.VarChar(255)
  idNumber             String?      @map("id_number") @db.VarChar(255)
  cellNumber           String?      @map("cell_number") @db.VarChar(255)
  county               String?      @map("county") @db.VarChar(255)
  subCounty            String?      @map("sub_county") @db.VarChar(255)
  dateOfBirth          DateTime?    @map("date_of_birth") @db.Date
  gender               String?      @map("gender")
  droppedOut           Boolean?     @map("dropped_out")
  transferred          Boolean?     @map("transferred")
  hubId                String?      @map("hub_id") @db.VarChar(255)
  hub                  Hub?         @relation(fields: [hubId], references: [id])
  implementerId        String?      @map("implementer_id") @db.VarChar(255)
  implementer          Implementer? @relation(fields: [implementerId], references: [id])
  supervisorId         String?      @map("supervisor_id") @db.VarChar(255)
  supervisor           Supervisor?  @relation(fields: [supervisorId], references: [id])
  students             Student[]

  @@map("fellows")
}

model Supervisor {
  id                String             @id @db.VarChar(255)
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  archivedAt        DateTime?          @map("archived_at")
  hubId             String?            @map("hub_id") @db.VarChar(255)
  hub               Hub?               @relation(fields: [hubId], references: [id])
  visibleId         String             @unique @map("visible_id") @db.VarChar(100)
  supervisorName    String?            @map("supervisor_name") @db.VarChar(255)
  supervisorEmail   String?            @unique @map("supervisor_email") @db.VarChar(255)
  idNumber          String?            @map("id_number") @db.VarChar(255)
  cellNumber        String?            @map("cell_number") @db.VarChar(255)
  mpesaNumber       String?            @map("mpesa_number") @db.VarChar(255)
  implementerId     String?            @map("implementer_id") @db.VarChar(255)
  implementer       Implementer?       @relation(fields: [implementerId], references: [id])
  memberId          Int?
  member            ImplementerMember? @relation(fields: [memberId], references: [id])
  county            String?            @map("county") @db.VarChar(255)
  subCounty         String?            @map("sub_county") @db.VarChar(255)
  bankName          String?            @map("bank_name") @db.VarChar(255)
  bankBranch        String?            @map("bank_branch") @db.VarChar(255)
  bankAccountName   String?            @map("bank_account_name") @db.VarChar(255)
  bankAccountNumber String?            @map("bank_account_number") @db.VarChar(255)
  kra               String?            @map("kra") @db.VarChar(255)
  nhif              String?            @map("nhif") @db.VarChar(255)
  nssf              String?            @map("nssf") @db.VarChar(255)
  dateOfBirth       DateTime?          @map("date_of_birth") @db.Date
  gender            String?            @db.VarChar(10)
  trainingLevel     String?            @map("training_level") @db.VarChar(255)
  droppedOut        Boolean?           @map("dropped_out")
  fellows           Fellow[]
  students          Student[]

  @@map("supervisors")
}

model School {
  id                          String       @id @db.VarChar(255)
  createdAt                   DateTime     @default(now()) @map("created_at")
  updatedAt                   DateTime     @updatedAt @map("updated_at")
  archivedAt                  DateTime?    @map("archived_at")
  schoolName                  String       @map("school_name") @db.VarChar(255) // e.g. Garden Estate
  schoolType                  String?      @map("school_type") @db.VarChar(255)
  schoolEmail                 String?      @map("school_email") @db.VarChar(255)
  schoolCounty                String?      @map("school_county") @db.VarChar(255) // e.g. Makueni
  schoolDemographics          String?      @map("school_demographics") @db.VarChar(255) // e.g. Mixed
  visibleId                   String       @unique @map("visible_id") @db.VarChar(100) // e.g. T2PS_School_6
  implementerId               String?      @map("implementer_id") @db.VarChar(255)
  implementer                 Implementer? @relation(fields: [implementerId], references: [id])
  hubId                       String?      @map("hub_id") @db.VarChar(255)
  hub                         Hub?         @relation(fields: [hubId], references: [id])
  pointPersonName             String?      @map("point_person_name") @db.VarChar(255)
  pointPersonId               String?      @map("point_person_id") @db.VarChar(255)
  pointPersonPhone            String?      @map("point_person_phone") @db.VarChar(255)
  pointPersonEmail            String?      @map("point_person_email") @db.VarChar(255)
  numbersExpected             Int?         @map("numbers_expected") // e.g. 700
  boardingDay                 String?      @map("boarding_day") @db.VarChar(255) // e.g. Day and boarding
  longitude                   Float?       @map("longitude")
  latitude                    Float?       @map("latitude")
  droppedOut                  Boolean?     @map("dropped_out")
  preSessionDate              DateTime?    @map("pre_session_date")
  session1Date                DateTime?    @map("session_1_date")
  session2Date                DateTime?    @map("session_2_date")
  session3Date                DateTime?    @map("session_3_date")
  session4Date                DateTime?    @map("session_4_date")
  clinicalFollowup1Date       DateTime?    @map("clinical_followup_1_date")
  clinicalFollowup2Date       DateTime?    @map("clinical_followup_2_date")
  clinicalFollowup3Date       DateTime?    @map("clinical_followup_3_date")
  clinicalFollowup4Date       DateTime?    @map("clinical_followup_4_date")
  clinicalFollowup5Date       DateTime?    @map("clinical_followup_5_date")
  clinicalFollowup6Date       DateTime?    @map("clinical_followup_6_date")
  clinicalFollowup7Date       DateTime?    @map("clinical_followup_7_date")
  clinicalFollowup8Date       DateTime?    @map("clinical_followup_8_date")
  dataCollectionFollowup1Date DateTime?    @map("data_collection_followup_1_date")
  students                    Student[]

  @@map("schools")
}

model Hub {
  id            String          @id @db.VarChar(255)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  archivedAt    DateTime?       @map("archived_at")
  visibleId     String          @unique @map("visible_id") @db.VarChar(10)
  hubName       String          @map("hub_name") @db.VarChar(255)
  coordinatorId String?         @map("coordinator_id")
  coordinator   HubCoordinator? @relation(fields: [coordinatorId], references: [id])
  implementerId String          @map("implementer_id") @db.VarChar(255)
  implementer   Implementer     @relation(fields: [implementerId], references: [id])
  // clinical_ops_supervisor_id // TODO: add after defining clinical workflows
  fellows       Fellow[]
  supervisors   Supervisor[]
  schools       School[]

  @@map("hubs")
}

model HubCoordinator {
  id                String      @id @db.VarChar(255)
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")
  archivedAt        DateTime?   @map("archived_at")
  visibleId         String      @unique @map("visible_id") @db.VarChar(10) // e.g. 23_HC_01
  coordinatorName   String      @map("coordinator_name") @db.VarChar(255) // e.g. Beverly
  coordinatorEmail  String?     @unique @map("coordinator_email") @db.VarChar(255) // e.g. nalietujoy@gmail.com
  idNumber          String?     @map("id_number") @db.VarChar(255)
  cellNumber        String?     @map("cell_number") @db.VarChar(255)
  mpesaNumber       String?     @map("mpesa_number") @db.VarChar(255)
  implementerId     String      @map("implementer_id") @db.VarChar(255)
  implementer       Implementer @relation(fields: [implementerId], references: [id])
  county            String?     @map("county") @db.VarChar(255)
  subCounty         String?     @map("sub_county") @db.VarChar(255)
  bankName          String?     @map("bank_name") @db.VarChar(255)
  bankBranch        String?     @map("bank_branch") @db.VarChar(255)
  bankAccountNumber String?     @map("bank_account_number") @db.VarChar(255)
  bankAccountName   String?     @map("bank_account_name") @db.VarChar(255)
  kra               String?     @map("kra") @db.VarChar(255)
  nhif              String?     @map("nhif") @db.VarChar(255)
  dateOfBirth       DateTime?   @map("date_of_birth") @db.Date
  gender            String?     @db.VarChar(10)
  trainingLevel     String?     @map("training_level") @db.VarChar(255)
  droppedOut        Boolean?    @map("dropped_out")
  // projects          Project[]
  hubs              Hub[]

  @@map("hub_coordinators")
}

/// A project is a representation of a research project within the academic school year.
// model Project {
//   id            String          @id @db.VarChar(255)
//   createdAt     DateTime        @default(now()) @map("created_at")
//   updatedAt     DateTime        @updatedAt @map("updated_at")
//   archivedAt    DateTime?       @map("archived_at")
//   visibleId     String          @unique @map("visible_id") @db.VarChar(10) // e.g. 2023_Project_2
//   projectName   String          @map("project_name") @db.VarChar(255)
//   leadId        String?         @map("lead_id")
//   lead          HubCoordinator? @relation(fields: [leadId], references: [id])
//   startDate     DateTime?       @map("start_date")
//   endDate       DateTime?       @map("end_date")
//   implementer   Implementer?    @relation(fields: [implementerId], references: [id])
//   implementerId String?         @db.VarChar(255)
//   hubs          Hub[]

//   @@map("projects")
// }
