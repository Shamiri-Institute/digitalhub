generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id           String               @id @db.VarChar(255)
  name         String               @unique
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  archivedAt   DateTime?            @map("archived_at")
  contactEmail String               @map("contact_email")
  memberships  OrganizationMember[]
  avatar       OrganizationAvatar?
  invites      OrganizationInvite[]

  @@map("organizations")
}

model OrganizationAvatar {
  id             String       @id @db.VarChar(255)
  organizationId String       @unique @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])
  fileId         String       @unique @map("file_id")
  file           File         @relation(fields: [fileId], references: [id])

  @@map("organization_avatars")
}

model File {
  id                 String              @id @db.VarChar(255)
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  archivedAt         DateTime?           @map("archived_at")
  key                String              @map("key")
  fileName           String              @map("file_name")
  byteSize           Int                 @map("byte_size")
  contentType        String              @map("content_type")
  width              Int?
  height             Int?
  signedUrl          String?             @map("signed_url") @db.VarChar(2048)
  expiresAt          DateTime?           @map("expires_at")
  organizationAvatar OrganizationAvatar?
  userAvatar         UserAvatar?

  @@map("files")
}

model User {
  id          String               @id @db.VarChar(255)
  email       String               @unique
  name        String               @db.VarChar(100)
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")
  archivedAt  DateTime?            @map("archived_at")
  avatar      UserAvatar?
  memberships OrganizationMember[]
  recentOpens UserRecentOpen[]

  @@map("users")
}

model UserRecentOpen {
  id       Int      @id @default(autoincrement())
  userId   String   @map("user_id") @db.VarChar(255)
  user     User     @relation(fields: [userId], references: [id])
  itemId   String   @map("item_id") // TODO: itemId leverages object ids (e.g. school_01hbnsp5eserr939h1v6s1ty5r) and polymorphic associations
  openedAt DateTime @default(now()) @map("opened_at")

  @@index([userId, itemId])
  @@map("user_recent_opens")
}

model UserAvatar {
  id     String @id @db.VarChar(255)
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])
  fileId String @unique @map("file_id")
  file   File   @relation(fields: [fileId], references: [id])

  @@map("user_avatars")
}

model OrganizationMember {
  id             Int                @id @default(autoincrement())
  organizationId String             @map("organization_id") @db.VarChar(255)
  organization   Organization       @relation(fields: [organizationId], references: [id])
  userId         String             @map("user_id") @db.VarChar(255)
  user           User               @relation(fields: [userId], references: [id])
  roles          MemberRole[]
  permissions    MemberPermission[]
  Hub            Hub[]

  @@map("organization_members")
}

model OrganizationInvite {
  id             Int          @id @default(autoincrement())
  email          String
  organizationId String       @map("organization_id") @db.VarChar(255)
  organization   Organization @relation(fields: [organizationId], references: [id])
  sentAt         DateTime     @default(now()) @map("sent_at")
  expiresAt      DateTime     @map("expires_at")
  acceptedAt     DateTime?    @map("accepted_at")
  roleId         String       @map("role_id") @db.VarChar(255)
  role           Role         @relation(fields: [roleId], references: [id])
  secureToken    String       @map("secure_token")

  @@unique([email, organizationId, secureToken])
  @@map("organization_invites")
}

model Role {
  id          String               @id @db.VarChar(255)
  name        String               @db.VarChar(255)
  description String               @db.VarChar(255)
  members     MemberRole[]
  permissions RolePermission[]
  invites     OrganizationInvite[]

  @@map("roles")
}

model MemberRole {
  id       Int                @id @default(autoincrement())
  memberId Int                @map("member_id")
  member   OrganizationMember @relation(fields: [memberId], references: [id])
  roleId   String             @map("role_id") @db.VarChar(255)
  role     Role               @relation(fields: [roleId], references: [id])

  @@map("member_roles")
}

model Permission {
  id                Int                @id @default(autoincrement()) @db.SmallInt
  permissionLabel   String             @unique @map("permission_label") @db.VarChar(255)
  memberPermissions MemberPermission[]
  rolePermissions   RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       String     @map("role_id") @db.VarChar(255)
  role         Role       @relation(fields: [roleId], references: [id])
  permissionId Int        @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@map("role_permissions")
}

model MemberPermission {
  id           Int                @id @default(autoincrement())
  memberId     Int                @map("member_id")
  member       OrganizationMember @relation(fields: [memberId], references: [id])
  permissionId Int                @map("permission_id")
  permission   Permission         @relation(fields: [permissionId], references: [id])

  @@map("member_permissions")
}

model Student {
  id         String    @id @db.VarChar(255)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  archivedAt DateTime? @map("archived_at")
  hubId      String    @map("hub_id") @db.VarChar(255)
  hub        Hub       @relation(fields: [hubId], references: [id])

  @@map("students")
}

model Fellow {
  id           String     @id @db.VarChar(255)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")
  archivedAt   DateTime?  @map("archived_at")
  hubId        String     @map("hub_id") @db.VarChar(255)
  hub          Hub        @relation(fields: [hubId], references: [id])
  supervisorId String     @map("supervisor_id") @db.VarChar(255)
  supervisor   Supervisor @relation(fields: [supervisorId], references: [id])

  @@map("fellows")
}

model Supervisor {
  id         String    @id @db.VarChar(255)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  archivedAt DateTime? @map("archived_at")
  hubId      String    @map("hub_id") @db.VarChar(255)
  hub        Hub       @relation(fields: [hubId], references: [id])
  fellows    Fellow[]

  @@map("supervisors")
}

model School {
  id         String    @id @db.VarChar(255)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  archivedAt DateTime? @map("archived_at")
  hubId      String    @map("hub_id") @db.VarChar(255)
  hub        Hub       @relation(fields: [hubId], references: [id])
}

model Hub {
  id          String             @id @db.VarChar(255)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  archivedAt  DateTime?          @map("archived_at")
  hubName     String             @map("hub_name")
  memberId    Int                @map("member_id")
  member      OrganizationMember @relation(fields: [memberId], references: [id])
  fellows     Fellow[]
  supervisors Supervisor[]
  schools     School[]
  students    Student[]

  @@map("hubs")
}
